version: '3.8'

services:
  minio:
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

  upload-api:
    image: bus-alert-system:latest
    ports:
      - "4000:4000"
    environment:
      MINIO_ENDPOINT: minio:9000
    command: python upload_api.py
    depends_on:
      - minio

  # Face Recognition Service (Scaled)
  fr-service:
    image: bus-alert-system:latest
    deploy:
      replicas: 2 # Scale this up based on GPU resources
    environment:
      # If using GPU, uncomment below (requires nvidia-container-toolkit)
      # NVIDIA_VISIBLE_DEVICES: all
      PORT: 8000
    # command: python fr_service.py # Replace with actual entrypoint if different

  # Load Balancer for FR Services
  fr-lb:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - fr-service

  # Parallel Workers
  worker:
    image: bus-alert-system:latest
    deploy:
      replicas: 4
    environment:
      MINIO_ENDPOINT: minio:9000
      CONTAINER_API: http://fr-lb # Hits the Load Balancer
      MAX_GPU_CONCURRENCY: 1 # Concurrency control per FR instance
    command: python consumer.py
    depends_on:
      - minio
      - fr-lb

volumes:
  minio_data:
